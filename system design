# Qur'an Memorization System - Design Document

## 1. Governing Objective
**Maximize sequential Qur'anic verse recall with minimal cognitive friction.**

---

## 2. Application Structure

| Tab | Purpose |
|-----|---------|
| **Today** | Unified daily view: Reviews + Daily Portion |
| **Statistics** | Progress + error analysis (maturity levels, mindmap readiness, skipped) |
| **Todo** | Mindmap work queue (surah/part), fix mindmaps, similar-verse decisions |
| **Settings** | Configuration (schedule, active part, learned/skip, maturity, similarity registry) |

---

## 3. Desktop & Mobile Layout
- **Mobile**: Single column, bottom navigation.
- **Desktop**:
  - **Sidebar Navigation** (implied or left-aligned).
  - **Today**: Dual-pane. Reviews (Left) | Daily Portion (Right).
  - **Settings/Stats**: Grid layout (2-3 columns).

---

## 4. Today Tab

### Section 1: Reviews Due
- **Context**: Show pre-context verses.
- **Target**: Hidden target verses.
- **Interaction**:
  - **Progressive Reveal**: Unhides text chunk-by-chunk. **State must persist** until manual navigation.
  - **Grading**: "Remembered" / "Not Remembered" at end.

### Section 2: Daily Portion (formerly Listening)
- **Rename**: "Daily Portion".
- **Modes**: Audio (Player) / Read (Text).
- **Sequential Reading**: 
  - Shows verses in natural Quranic order (Surah by Surah).
  - Fixed issue where portions showed mixed surahs simultaneously.
- **Read Mode**:
  - Shows full text of the day's portion.
  - **Surah Transitions**: Clearly marks new Surah headers (Basmalah) when crossing boundaries.
- **Audio Mode**:
  - Automatically plays the next verse.
  - **Bismillah Transition**: Plays/Displays Bismillah when starting a new Surah.
- **Cycle**: Rotates through active part.

---

## 5. Settings Tab

### 5.1 Maturity Adjustment (NEW)
- Allow users to manually set the strength of a Surah/Part.
- **Levels**:
  - **Reset** (0 days)
  - **Medium** (~14 days ± spread)
  - **Strong** (~30 days ± spread)
  - **Mastered** (~90 days ± spread)
- **Logic**: Bulk updates `scheduler` state for all associated MemoryNodes. Use random fuzz factor to avoid "review avalanches".

---

## 6. Cloud Sync & Persistence (NEW)
- **Engine**: Supabase Auth + Database.
- **Strategy**: "Latest Wins" based on timestamps.
- **Conflict Resolution**:
  - `AppSettings` includes `updatedAt` ISO string.
  - Global `LAST_MODIFIED` timestamp in IndexedDB/LocalStorage tracks any local change.
  - `mergeBackups` compares `updatedAt` for settings instead of simple union to allow deletions (e.g. marking a surah as "new").
- **Auto-Sync**: Triggers on tab focus/visibility change to keep multiple devices in sync.

---

## 7. Similarity registry: store mutashabihat decisions and editable notes.

---

## 8. Logic Updates

### Review Reveal Fix
- Ensure `revealedChunks` state doesn't reset automatically.
- Buttons: "Reveal Chunk", "Next Verse".

### Surah Transitions
- In `ReadMode` loop, detect `if (curr.surahId !== prev.surahId) renderSurahHeader()`.

### Layout & Mobile Optimization
- Mobile: bottom nav. Desktop: nav docked right (`.bottom-nav` column).
- **Mobile UI Fixes**:
  - Modals (Add Mutashabih, Zoom) are smaller and have bottom margin to avoid "Reveal Chunk" overlap.
  - Toast notifications positioned at top-right on mobile.
  - Zoom controls scaled for touch friendliness.
- Use CSS Media Queries (`@media (min-width: 1024px)`) to switch from flex-col to grid.

### Mutashabihat & Suspension
- On 3 failed recalls for an anchor, suspend related mindmap reviews; surface in Todo > Fix Mindmaps. Clear suspension after confirming new mindmap.
- Mutashabihat-aware context: expand preview until a non-similar verse is found.
- Similarity decisions logged in Todo and editable in Settings; decisions hide items from Todo.

### Skip Surahs
- Skipped surahs removed from reviews, today portion, and mindmap queues; artifacts pruned on toggle.

---

## 9. Data Model

```typescript
// No schema changes needed, just logic updates.
MemoryNode {
  // ... existing fields
  scheduler: {
    interval: number; // Updated by Maturity settings
    repetition: number;
    efactor: number;
    dueDate: string; // Recalculated based on new interval
  }
}

AppSettings {
  // ... existing fields
  updatedAt: string; // ISO date for sync conflict resolution
  lastSyncedAt: string;
}
```

---

## 10. Tldraw Customizations (Preserved Features)

The Mindmap Editor (`src/components/MindmapEditor.tsx`) includes a custom Lasso Select tool. If this tool needs to be temporarily disabled for stability, the following implementation details should be used to restore it:

### Lasso Tool Implementation

To re-enable the Lasso tool:
1.  **Import Tldraw Dependencies**: Ensure `StateNode`, `atom`, `pointInPolygon`, `polygonsIntersect` are imported from `tldraw` (dynamically in `useEffect`).
2.  **Define Tool Classes**:
    *   `IdleState` (transitions to `lassoing` on pointer down).
    *   `LassoingState` (tracks pointer moves, updates an `atom` with points, and on pointer up selects shapes within the lasso polygon).
    *   `LassoSelectTool` (parent `StateNode`, id: `'lasso-select'`).
3.  **Register Tool**: Pass the tool classes to `setLassoTool`.
4.  **UI Overrides**:
    *   Use `uiOverrides` prop on `Tldraw` component to add the `lasso-select` tool to the registry.
    *   Set `icon: 'color'`, `kbd: 'w'`.
5.  **Custom Toolbar**:
    *   Create a custom component for `Toolbar`.
    *   Include `TldrawUiMenuItem` for the lasso tool.
    *   Include standard tools (`SelectToolbarItem`, `HandToolbarItem`, `DrawToolbarItem`, `HighlightToolbarItem`, `EraserToolbarItem`).
6.  **Lasso Overlay**:
    *   Create a component using `useEditor`, `useValue` to render an SVG path of the lasso points on top of the canvas.
    *   Pass this to the `components.Overlays` prop.

### Code Snippet (Reference)

```typescript
// Inside loadTldraw useEffect:
class LassoingState extends StateNode {
    // ... setup markId, points atom ...
    override onPointerMove() { this.points.set([...this.points.get(), currentPoint]); }
    override onPointerUp() { 
        // Logic to filter shapes inside polygon and editor.setSelectedShapes(shapes)
    }
}
// Render props:
<Tldraw tools={[LassoSelectTool]} overrides={uiOverrides} components={components} />
```
